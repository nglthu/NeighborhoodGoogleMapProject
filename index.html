<html>

<head>
	
	<script asyn src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
	<script asyn src='https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>
	<script asyn src='https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.0/knockout-min.js'>
	</script>
</head>

<body>
	<div class="container">
		<div class="options-box">
			<h1></h1>
			<div>
				<!--<select placeholder="Searchâ€¦" type="search" data-bind="options: locations,
                   //    optionsText: 'title',
					   optionsValue:'title',
                       value: selectedChoice,
                       optionsCaption: 'Choose...', event:{change:textSearchPlaces}, valueUpdate:'keyup' " autocomplete="off" size="15"></select>-->
				<!--value: query, valueUpdate: 'keyup'" autocomplete="off"-->
				<label>Search for Destination:</label>
				<input id="text" data-bind="valueUpdate:'keypress', click:enterSearch,event: {keypress: enterSearch, change:textSearchPlaces}" autocomplete="on"> </div>
			<div id="map" data-bind="text:map"></div>
		</div>
		<script>
			$(function () {				

				function dataSource(request, response) {
					function hasMatch(s) {
						return s.toString().toLowerCase().indexOf(request.term.toLowerCase()) !== -1;
					};
					var i, l, obj, matches = [];
					if (request.term === "") {
						response([]);
						return;
					}
					for (i = 0, l = locations().length; i < l; i++) {
						obj = locations()[i];
						if (hasMatch(obj.title)) {
							matches.push(obj);
						}
					}
					response(matches);
				}
				$(document).ready(function () {
					$("#text").autocomplete({
						source: dataSource,
						minLength:0,
						focus: function (event, ui) {
							$("#text").val(ui.item.title);
							//$(this).data("autocomplete").search($(this).val());
							$(this).data('ui-autocomplete').search("");
							
							return false;
						}
						, select: function (event, ui) {
							$("#text").val(ui.item.title);
							/*$("#project-id").val(ui.item.value); // is this needed?
							//$("#project-title").html(ui.item.label);
							$("#project-description").html(ui.item.desc);
							$("#project-other").html(ui.item.other);*/
							return false;
						}
					})
					.data( "ui-autocomplete" )._renderItem = function( ul,item ) {
        				return $( "<p>" )
					.append( "<a style='font-size:70% ;margin-left:0; width:70%'>" + item.title + "<br><span style='font-size:90%;display:table;min-width:50%;width:70%;margin:0'>Desc: " + item.detail + "</span>"+"</a>" )
																		
                   .appendTo( ul );
						
                    };
					
					
					/*$("#text").focus(function () {
    				//$(this).ui-autocomplete("search", "");
					});*/
				});
			});
			var map;
			var myViewModel = function () {
				this.locations = ko.observableArray([
					{
						title: 'Subway'
						, location: {
							lat: -36.8737632
							, lng: 174.7936569
						},
						detail:""
					}
					, {
						title: 'St. Helier'
						, location: {
							lat: -36.8582446
							, lng: 174.8369475
						},
						detail:''
					}
					, {
						title: 'Auckland Town Hall'
						, location: {
							lat: -36.8530296
							, lng: 174.7630188
						},
						detail:'A historic building  on Queen Street'
					}
					, {
						title: 'Auckland University of Technology (South Campus)'
						, location: {
							lat: -36.9196601
							, lng: 174.7545022
						},
						detail:''
					}
					, {
						title: 'Central City Library'
						, location: {
							lat: -36.851759
							, lng: 174.7632119
						},
						detail:''
					}
					, {
						title: 'Q Theatre'
						, location: {
							lat: -36.8533432
							, lng: 174.7610524
						},
						detail:''
					}
					, {
						title: 'The Civic'
						, location: {
							lat: -36.851036
							, lng: 174.7617099
						},
						detail:''
					}
        ]);
				this.selectedChoice = ko.observable();
				this.textSearchPlaces = ko.observable();
				this.enterSearch = function (d, e) {
					if (e.keyCode == 13 || e.keyCode == 40) {
						this.textSearchPlaces();
					}
					//e.keyCode === 40 && this.textSearchPlaces();							
					return true;
				};
				
			}

			function initMap() {
				map = new google.maps.Map(document.getElementById('map'), {
					center: {
						lat: -36.85293
						, lng: 174.7611372
					}
					, zoom: 14
					, mapTypeControl: false
				});
				var markers = [];
				var bounds = new google.maps.LatLngBounds();
				var largeInfowindow = new google.maps.InfoWindow();
				var addMarker = function (position, title, map) {
					return new google.maps.Marker({
						position: position
						, title: title
						, map: map
					});
				}
				for (i = 0; i < this.locations().length; i++) {
					var position = this.locations()[i].location;
					var title = this.locations()[i].title;
					var marker = addMarker(position, title, map);
					markers.push(marker);
					bounds.extend(marker.position);
					
					marker.addListener('click', function () {
						populateInfoWindow(this, largeInfowindow);
					});
				}
				for (i = 0; i < markers.length; i++) {
					markers[i].setMap(map);
					bounds.extend(markers[i].position);
				}

				function populateInfoWindow(marker, infowindow) {
					// Check to make sure the infowindow is not already opened on this marker.
					if (infowindow.marker != marker) {
						// Clear the infowindow content to give the streetview time to load.
						infowindow.setContent('');
						infowindow.marker = marker;
						// Make sure the marker property is cleared if the infowindow is closed.
						infowindow.addListener('closeclick', function () {
							infowindow.marker = null;
						});
						/*infowindow.addListener('mouseout', function () {
							//infowindow.marker = null;
						});*/
						var streetViewService = new google.maps.StreetViewService();
						var radius = 50;
						// In case the status is OK, which means the pano was found, compute the
						// position of the streetview image, then calculate the heading, then get a
						// panorama from that and set the options
						function getStreetView(data, status) {
							if (status == google.maps.StreetViewStatus.OK) {
								var nearStreetViewLocation = data.location.latLng;
								var heading = google.maps.geometry.spherical.computeHeading(nearStreetViewLocation, marker.position);
								infowindow.setContent('<div>' + marker.title + '</div><div id="pano"></div>');
								var panoramaOptions = {
									position: nearStreetViewLocation
									, pov: {
										heading: heading
										, pitch: 30
									}
								};
								var panorama = new google.maps.StreetViewPanorama(document.getElementById('pano'), panoramaOptions);
							}
							else {
								infowindow.setContent('<div>' + marker.title + '</div>' + '<div>No Street View Found</div>');
							}
						}
						streetViewService.getPanoramaByLocation(marker.position, radius, getStreetView);
						// Open the infowindow on the correct marker.
						infowindow.open(map, marker);
					}
				}
				this.textSearchPlaces = function (event) {
					//alert('test');
					var selectedChoice = document.getElementById('text').value;
					hideMarkers(markers);
					var marker2 = new google.maps.Marker();
					marker2.setMap(null);
					var largeInfowindow = new google.maps.InfoWindow();
					var bounds = new google.maps.LatLngBounds()
					for (var i = 0; i < locations().length; i++) {
						//	marker2.setMap('null');
						//InfoWindow.close();
						/*if (locations()[i].title == selectedChoice()) {*/
						if (locations()[i].title == selectedChoice) {
							var position = locations()[i].location;
							var title = locations()[i].title;
							console.log("Positon:" + position);
							console.log("title" + title);
							//createMarkersForPlaces(locations()[i]);
							marker2 = addMarker(position, title, map);
							//populateInfoWindow(this, largeInfowindow);
							bounds.extend(marker2.position);
							/*}, new google.maps.LatLngBounds());*/
							markers.push(marker2);
							map.setCenter(bounds.getCenter());
							map.fitBounds(bounds);
							var listener = google.maps.event.addListener(map, "idle", function () {
								if (map.getZoom() > 14) map.setZoom(14);
								google.maps.event.removeListener(listener);
							});
							//alert('test');
							marker2.setMap(map);
							populateInfoWindow(marker2, largeInfowindow);
						}
					}
					/*marker2.addListener('mouseover', function () {
					//	populateInfoWindow(this, largeInfowindow);
					});*/
					//	console.log(marker2.position);
					//	marker2.setMap(map);
					/*var bounds = markers.reduce(function (bounds, marker) {*/
				}

				function createMarkersForPlaces(places) {
					var bounds = new google.maps.LatLngBounds();
					// Create a marker for each place.
					var marker = new google.maps.Marker({
						map: map
						, title: places.title
						, position: places.location
					});
					// If a marker is clicked, do a place details search on it in the next function.
					map.fitBounds(bounds);
				}

				function hideMarkers(markers) {
					for (var i = 0; i < markers.length; i++) {
						markers[i].setMap(null);
					}
				}
			}
			//ko.applyBindings(myModel);
			/*myViewModel.selectionChanged=ko.dependentObservable(function(event){
				alert("test");
			});*/
			ko.applyBindings(myViewModel);
			//jquery
		</script>
</body>
<script async defer src="https://maps.googleapis.com/maps/api/js?libraries=places,geometry,drawing&key=AIzaSyBnaS5G8LBLYT0EqlZTIH7k3EHXK1GcPd8&v=3&callback=initMap">
</script>

</html>
<style>
	html,
	body {
		font-family: Arial, sans-serif;
		height: 100%;
		margin: 0;
		padding: 0;
	}
	
	.container {
		height: 100%;
		position: relative;
	}
	
	input {
		font-size: 12px;
		width:100%;
		height:50px;
	}
	
	h1 {
		color: #525454;
		font-size: 22px;
		margin: 0 0 10px 0;
		text-align: center;
	}
	
	#hide-listings,
	#show-listings {
		width: 48%;
	}
	
	hr {
		background: #D0D7D9;
		height: 1px;
		margin: 20px 0 20px 0;
		border: none;
	}
	
	#map {
		bottom: 0px;
		width:100%;
		height: 100%;
		left: 362px;
		position: absolute;
		right: 0px;
	}
	
	.options-box {
		background: #fff;
		border: 1px solid #999;
		border-radius: 3px;
		height: 100%;
		line-height: 35px;
		padding: 10px 10px 30px 10px;
		text-align: left;
		width: 340px;
	}
	
	#pano {
		width: 200px;
		height: 200px;
	}
	
	.text {
		font-size: 12px;
	}
	
	#toggle-drawing {
		width: 27%;
		position: relative;
		margin-left: 10px;
	}
</style>